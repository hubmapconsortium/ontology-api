# HubMAP OpenAPI Server

## Overview
This server was generated by the [OpenAPI Generator](https://openapi-generator.tech) project. By using the
[OpenAPI-Spec](https://openapis.org) located in the top level directory as [ontology-api-spec.yml](../ontology-api-spec.yml).
The server is created using the [build-server.sh](../build-server.sh) shell script.

A [Postman](https://www.postman.com/) collection [Ontology.postman_collection.json](./postman/Ontology.postman_collection.json) for accessing/testing the [RestFUL](https://en.wikipedia.org/wiki/Representational_state_transfer) endpoints available.
To use it you will need to setup the following Postman Environments:
* ***localhost***: defining **ontology_url** as [http://localhost:8080](http://localhost:8080)
* ***dev***: defining **ontology_url** as [https://ontology-api.dev.hubmapconsortium.org](https://ontology-api.dev.hubmapconsortium.org)

The server uses the [Connexion](https://github.com/zalando/connexion) library on top of [Flask](https://flask.palletsprojects.com/en/2.0.x/).

## Design
The OpenAPI Generator will create the server in **openapi_server**.
All endpoints and Flask related calls are kept in **controllers/default_controller.py**.
Each controller makes one call to a method of the same name found in **managers/neo4j_manager.py**.
In this manner the OpenAPI generated Flask code is separated from the business logic located in the manager.

Adding a new endpoint requires updating the **ontology-api-spec.yml**, running **build-server.sh**,
creating an additional business logic method in **neo4j_manager.py**.
Note that generating the new server will remove all calls from the controller to the manager.

## Running Locally
Executing the following script will start the server locally accessing the Neo4J database running in dev.

```
./run_server_on_localhost.py
```

Alternately, the following will rebuild the server and then run it.
```
./build-server.sh -r
```

The server will be available at the URL
```
http://localhost:8080/
```

## Rebuilding the Docker container

To get the latest version of the server on the server execute the following:

```bash
# Access the server, switch accounts and go to the server directory
$ ssh -i ~/.ssh/id_rsa_e2c.pem cpk36@ingest.dev.hubmapconsortium.org
$ sudo /bin/su - centos
$ cd hubmap/ontology-api
# Get the most recent version of the code
$ git pull
```

At this point you can shut down the server, remove the old image, rebuild it, and restart it.
```bash
# Shut down the server
$ docker images
REPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE
ontology-api_ontology-api   latest              24b1f748f10f        31 minutes ago      77.6MB
...

# Stop process and remove old image...
$ export ONTOLOGY_API_VERSION=latest; docker-compose -f docker-compose.deployment.yml down --rmi all
Stopping ontology-api ... done
Removing ontology-api ... done
Network gateway_hubmap is external, skipping

# Rebuild the image
$ docker-compose -f docker-compose.deployment.api.yml build --no-cache
Building ontology-api
...
Successfully built 3dd48d5cedbd
Successfully tagged ontology-api_ontology-api:latest

# Startup the container
$ docker-compose -f docker-compose.deployment.api.yml up -d
Creating ontology-api ... done

# Verify that it is running
$ docker ps
CONTAINER ID        IMAGE                        COMMAND                  CREATED             STATUS                 PORTS           NAMES
95ff4678fab4        ontology-api_ontology-api    "/usr/local/bin/entrâ€¦"   8 seconds ago       Up 8 seconds           5000/tcp        ontology-api
```

Disconnect from the server
```bash
$ exit
logout
[cpk36@ip-172-31-91-142 ~]$ exit
logout
Connection to ingest.dev.hubmapconsortium.org closed.
```

## Setting permissions on the endpoints

The [hubmapconsortium/gateway](https://github.com/hubmapconsortium/gateway/) defines the protection on endpoints
for: dev, test, start, and prod. Currently there is no protection set on the endpoints and so they should be marked as follows:
```bash
{
  "ontology-api.dev.hubmapconsortium.org": [
   {
      "method": "GET",
      "endpoint": "/fullCapacityParameterizedTerm/<*>",
      "auth": false
    }
  ]
}
```

## Confirm that the server is running and has access to the database

You can do this in two ways. The first is through the postman collection found in the 'server/postman' directory.
The second way is by running a program that accesses the server through an OpenAPI generated interface.
It is this second method that weill be discussed here.

The file './client_programs/terms_term_id_terms.py' was written to test access to the server using the OpenAPI generated interface.
As such the program also was intended to serve as an example of using the OpenAPI generated interface.
In order to use it you will have to have built the server './build_server.sh' using the '-c' optional parameter which will build the client from the openapi spec.
```bash
$ ./build_server.sh -c
```

To run this program you will need to generate an input file consisting of a term to search for.
For a term, you can use something simple like 'cancer'. By default output is sent to stdout. You should see something like the following.
```bash
$ source venv/bin/activate
$ cd client_programs
$ echo 'cancer' > test.txt
$ ./terms_term_id_terms.py test.txt
code_id,code_sab,code,concept,tty,term,matched,rel_type,rel_sab
NCI C9305,NCI,C9305,C0006826,AB,CA,cancer,,
NCI_CDISC C9305,NCI_CDISC,C9305,C0006826,SY,CA,cancer,,
PDQ CDR0000041060,PDQ,CDR0000041060,C0006826,AB,CA,cancer,,
CHV 0000053965,CHV,0000053965,C0998265,PT,crab,cancer,,
CHV 0000002337,CHV,0000002337,C0006826,PT,cancer,cancer,,
CSP 2000-0173,CSP,2000-0173,C0006826,ET,cancer,cancer,,
...
ICD10AM C80,ICD10AM,C80,C0006826,PT,Malignant neoplasm without specification of site,cancer,,
ICD10CM C80,ICD10CM,C80,C0006826,HT,Malignant neoplasm without specification of site,cancer,,
ICD10CM C80,ICD10CM,C80,C0006826,AB,Malignant neoplasm without specification of site,cancer,,
ICD9CM 199,ICD9CM,199,C0006826,HT,Malignant neoplasm without specification of site,cancer,,
MDR 10026655,MDR,10026655,C0006826,LLT,Malignant neoplasm without specification of site,cancer,,
SNOMEDCT_US 86049000,SNOMEDCT_US,86049000,C1306459,FN,Malignant neoplasm, primary (morphologic abnormality),cancer,,
```
